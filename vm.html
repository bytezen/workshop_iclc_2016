<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<title>ICLC 2016 Workshop: Design a Mini-Language</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://fonts.googleapis.com/css?family=Raleway:400,300,600" rel="stylesheet" type="text/css">
<link rel="stylesheet" href="css/normalize.css">
<link rel="stylesheet" href="css/skeleton.css">
<link rel="stylesheet" href="css/codemirror.css">
<link rel="stylesheet" href="css/github.min.css">

<script src="js/jquery.min.js"></script>

<script src="js/marked.js"></script>
<script src="js/highlight.min.js"></script>
<script src="js/hljs/javascript.min.js"></script>

<script src="js/peg.min.js"></script>
<script src="js/pegjs.pegjs.js"></script>

<script src="js/codemirror.min.js"></script>
<script src="js/mode/pegjs.min.js"></script>

<script src="js/big.min.js"></script>
<script src="js/gibberish.min.js"></script>
<script src="js/iclc.js"></script>

<style>
/* see http://getskeleton.com/ */
html { font-size: 50%; } 
table { width:100%; }
</style>
</head>
<body>

<script type="bogus" id="sourcetext">

# Target virtual machine

<div id="toc"></div>

**Click on any of the code samples below to hear them!**

## Sounds

The VM comes with a small number of instruments to get things going. Here's a plucked string instrument. There are two ways to trigger it. You can use @pluck-note to set the frequency and amplitude for each note like this:

<pre><code onclick="seq.play_element_text(this)">[440, 1, "@pluck-note"]</code></pre>

<pre><code onclick="seq.play_element_text(this)">[220, 0.25, "@pluck-note"]</code></pre>

Or you can set the frequency and amplitude as contextual variables, and just use @pluck to trigger using these values. This can allow a bit more flexibility in how these values are calculated:

<pre><code onclick="seq.play_element_text(this)">["@pluck"]</code></pre>

<pre><code onclick="seq.play_element_text(this)">[[330, "@set-freq"], [0.5, "@set-amp"], "@pluck"]</code></pre>

There are also some percussion sounds, which either grab amplitude from the context (set using @set-amp), or specify it using the -note variants:

<pre><code onclick="seq.play_element_text(this)">[1, "@hat-note"]</code></pre>

<pre><code onclick="seq.play_element_text(this)">[1, "@kick-note"]</code></pre>

<pre><code onclick="seq.play_element_text(this)">[1, "@snare-note"]</code></pre>


<pre><code onclick="seq.play_element_text(this)">[[1, "@set-amp"], "@hat"]</code></pre>

<pre><code onclick="seq.play_element_text(this)">[[1, "@set-amp"], "@kick"]</code></pre>

<pre><code onclick="seq.play_element_text(this)">[[1, "@set-amp"], "@snare"]</code></pre>

<pre><code onclick="seq.play_element_text(this)">[4, "@repeat", [
	[["@alt", [0.3, 1]], "@set-amp"], 
	8, "@repeat", ["@hat", 0.125, "@wait"]
]]</code></pre>

## Repetition and parallelism

A list with several events normally happens at the same time:

<pre><code onclick="seq.play_element_text(this)">[
	[220, "@set-freq"], "@pluck", 
	[330, "@set-freq"], "@pluck"
]</code></pre>


Unless you add a n,@wait:

<pre><code onclick="seq.play_element_text(this)">[
	[220, "@set-freq"], "@pluck", 
	1, "@wait",
	[330, "@set-freq"], "@pluck"
]</code></pre>

Here's how to do something a specific number of times:

<pre><code onclick="seq.play_element_text(this)">[
	4, "@repeat", [ "@pluck", 0.25, "@wait" ]
]</code></pre>

<pre><code onclick="seq.play_element_text(this)">[
	4, "@repeat", [ "@pluck", 0.25, "@wait" ],
	[220, "@set-freq"], "@pluck"
]</code></pre>

Here's how to do something forever:

<pre><code onclick="seq.play_element_text(this)">[
	"@loop", [ "@pluck", 0.25, "@wait" ]
]</code></pre>

<button class="button-primary" onclick="seq.clear()">Stop</button>

Note that @loop will run the pattern that follows it *in parallel*, which means that you can keep on triggering more things after it. So it's easy to set up a bunch of parallel processes:

<pre><code onclick="seq.play_element_text(this)">[
	"@loop", [ 0.5, "@kick-note", 2, "@wait" ],
	"@loop", [ 0.3, "@hat-note", 0.4, "@wait" ],
	"@loop", [ 550, 0.5, "@pluck-note", 0.6, "@wait" ],
	"@loop", [ 330, 0.4, "@pluck-note", 0.2, "@wait" ],
	"@loop", [ 110, 1, "@pluck-note", 12, "@wait" ]
]</code></pre>

<button class="button-primary" onclick="seq.clear()">Stop</button>


And to run something in parallel without looping it, just use @fork []:

<pre><code onclick="seq.play_element_text(this)">[
	"@loop", [ 
		"@kick", 
		"@fork", [
			0.25, "@wait", 
			550, 1, "@pluck-note",
			0.33, "@wait", 
			660, 1, "@pluck-note"
		],
		1, "@wait"
	]
]</code></pre>

<button class="button-primary" onclick="seq.clear()">Stop</button>


This is also handy for setting up loops with different start times:

<pre><code onclick="seq.play_element_text(this)">[
	"@loop", ["@kick", 1, "@wait"],
	"@fork", [0.5, "@wait", 
		"@loop", ["@hat", 1, "@wait"]
	]
]</code></pre>

<button class="button-primary" onclick="seq.clear()">Stop</button>


## Expressions

Anywhere that a number would go, you can insert an expression. Here are some fun expressions.

Here's picking a value at random from a list, instead of giving the freq and amp values as numbers:


<pre><code onclick="seq.play_element_text(this)">[
	"@loop", [ 
		["@pick", [330, 440, 550, 660]], 
		["@pick", [1, 0.7, 0.4]],
		"@pluck-note",
		0.25, "@wait"
	]
]</code></pre>

<button class="button-primary" onclick="seq.clear()">Stop</button>

Here's alternating between a set of values in a list, one at a time:

<pre><code onclick="seq.play_element_text(this)">[
	"@loop", [ 
		["@alt", [330, 440, 550, 660]],
		["@alt", [1, 0.7, 0.4]],
		"@pluck-note",
		0.25, "@wait"
	]
]</code></pre>

<button class="button-primary" onclick="seq.clear()">Stop</button>

Here's way to set the probability of something happening. Note that two lists have to be given after the "@chance"; either the first is run (if the chance happens), else the other one will be run. 

<pre><code onclick="seq.play_element_text(this)">[
	"@loop", [
		"@fork", [ 
			0.1, 
			"@chance",
			["@snare"],
			["@kick"]
		],
		"@hat", 0.25, "@wait"
	]
]</code></pre>

<button class="button-primary" onclick="seq.clear()">Stop</button>


If you don't care about the 'else' case, just put an empty list ```[]``` or ```null```. But you must put something, or else the virtual machine will get corrupted, and who knows what might happen.

<pre><code onclick="seq.play_element_text(this)">[
	"@loop", [
		"@fork", [ 
			0.1, 
			"@chance",
			["@snare"],
			[]
		],
		"@hat", 0.25, "@wait"
	]
]</code></pre>

<button class="button-primary" onclick="seq.clear()">Stop</button>

Another way of getting some randomness is to use the @rand (which generates a number between 0 and 1), @srand (which generates a number between -1 and 1), and n,@randi (which generates a number between 0 and n-1):

<pre><code onclick="seq.play_element_text(this)">[
	"@loop", [ 
		"@rand", "@set-amp",
		"@pluck",
		0.25, "@wait"
	]
]</code></pre>

<pre><code onclick="seq.play_element_text(this)">[
	"@loop", [ 
		"@pluck",
		[3, "@randi"], "@wait"
	]
]</code></pre>

<button class="button-primary" onclick="seq.clear()">Stop</button>

There are several basic math functions that can be used to map numbers into useful ranges. Note that most math functions require the arguments first, e.g. use ```[a,b,@+]``` to add a and b:

<pre><code onclick="seq.play_element_text(this)">[
	"@loop", [ 
		[[[4, "@randi"], 1, "@+"], 110, "@*"], "@set-freq",
		"@pluck",
		0.25, "@wait"
	]
]</code></pre>

<pre><code onclick="seq.play_element_text(this)">[
	"@loop", [ 
		[["@srand", 10, "@*"], 110, "@+"], "@set-freq",
		"@pluck",
		0.25, "@wait"
	]
]</code></pre>

<button class="button-primary" onclick="seq.clear()">Stop</button>

## Get, set, and let

The @set-freq etc. are really just examples of creating named values ("variables") that can be re-used again later. Actually you can use @set-*anything* to create whatever variables you like, and use @get-*anything* to retrieve them. Mainly this is useful when you want to re-use something a few times:

<pre><code onclick="seq.play_element_text(this)">[
	"@loop", [ 
		[[[4, "@randi"], 2, "@+"], 110, "@*"], "@set-f",
		"@get-f", 0.6, "@pluck-note",
		["@get-f", 1.5, "@mul"], 0.6, "@pluck-note",
		0.25, "@wait"
	]
]</code></pre>
<button class="button-primary" onclick="seq.clear()">Stop</button>

By default @set-*anything* will apply globally, so you can modulate a parameter from one loop while using it in another:

<pre><code onclick="seq.play_element_text(this)">[
	"@loop", [
		[[[4, "@randi"], 2, "@+"], 110, "@*"], "@set-f",
		1, "@wait"
	],
	"@loop", [ 
		"@get-f", 0.6, "@pluck-note",
		["@get-f", 1.5, "@mul"], 0.6, "@pluck-note",
		0.25, "@wait"
	]
]</code></pre>
<button class="button-primary" onclick="seq.clear()">Stop</button>

If globalism isn't what you care for, you can make a name "local" to a particular loop by using @let-*anything*. Once you have @let- a variable in a particular @loop (or @fork) pattern, it will remain local to that pattern. Generally, use @let if you want some value that is only used within a pattern, and @set if you want something global. 

<pre><code onclick="seq.play_element_text(this)">[
	"@loop", [
		[[[4, "@randi"], 1, "@+"], 110, "@mul"], "@let-f",
		"@get-f", 0.6, "@pluck-note",
		["@get-f", 1.5, "@mul"], 0.6, "@pluck-note",
		0.25, "@wait"
	],
	"@loop", [
		[[[4, "@randi"], 5, "@+"], 110, "@mul"], "@let-f",
		"@get-f", 1, "@pluck-note",
		["@get-f", 1.5, "@mul"], 0.6, "@pluck-note",
		0.25, "@wait"
	]
]</code></pre>
<button class="button-primary" onclick="seq.clear()">Stop</button>

One use for this is to repeatedly modify a value, such as for a counter, or a decay:

<pre><code onclick="seq.play_element_text(this)">[
	"@loop", [
		1, "@let-a",
		8, "@repeat", [
			"@get-a", "@snare-note",
			0.25, "@wait",
			["@get-a", 0.6, "@*"], "@set-a"
		]
	]
]</code></pre>
<button class="button-primary" onclick="seq.clear()">Stop</button>

The only thing special about @set-freq is that the name "freq" is used by @pluck. That is, @pluck is equivalent to: ```["@get-freq", "@get-amp", "@pluck-note"]```. Similarly for @set-amp etc.

---

## Test area

Type any pattern into the text box below and click to run it.  

<textarea class="CodeMirror" onclick="seq.play_element_value(this)">["@pluck"]</textarea>
<button class="button-primary" onclick="seq.clear()">Stop</button>


</script>

<div class="container">
	<div class="row" style="margin-top: 25%">
		<div class="full column" id="main_body" />
	</div>
</div>

<script>

var body = document.getElementById('sourcetext').innerText;
document.getElementById('main_body').innerHTML = marked(body);
document.getElementById('toc').innerHTML = marked(toc.join("\n"));



////////////////////////////////////////////////////////////////////////////////

//seq_define("default", code); 

</script>

</body>
</html>